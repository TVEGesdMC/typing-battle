<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typing Battle - Leaderboard</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="leaderboard-container">
        <h1>🏆 Hall of Warriors 🏆</h1>
        <p>The greatest warriors who have conquered the most levels</p>

        <div id="leaderboard-content"></div>

        <div style="margin-top: 20px;">
            <a href="index.html" class="btn">⚔️ Return to Battle</a>
            <button class="btn btn-secondary" onclick="logout()">🚪 Leave Arena</button>
        </div>
    </div>

    <script>
        async function loadLeaderboard() {
            try {
                const response = await fetch('/api/leaderboard');
                const data = await response.json();
                const currentUser = localStorage.getItem('currentUser');
                const content = document.getElementById('leaderboard-content');

                if (!data.success || data.users.length === 0) {
                    content.innerHTML = '<div class="no-data">🏟️ The arena awaits its first warriors! Be the first to enter battle!</div>';
                    return;
                }

                // Users are already sorted by maxLevel
                const sortedUsers = data.users;

                let tableHTML = `
                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th class="rank">🏅 Rank</th>
                                <th>⚔️ Warrior</th>
                                <th>🏷️ Title</th>
                                <th>🗲 Max Level</th>
                                <th>🎯 Battles Fought</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                // Get global data for YouTuber titles
                const globalResponse = await fetch('/api/global-data');
                const globalData = await globalResponse.json();
                const youtuberTitles = globalData.youtuberTitles || {};

                sortedUsers.forEach((user, index) => {
                    const rank = index + 1;
                    const isCurrentUser = user.username === currentUser;
                    const rankClass = rank <= 3 ? `rank-${rank}` : '';
                    const rowClass = isCurrentUser ? 'current-user' : '';

                    let rankDisplay = rank;
                    if (rank === 1) rankDisplay = '🥇';
                    else if (rank === 2) rankDisplay = '🥈';
                    else if (rank === 3) rankDisplay = '🥉';

                    // Get user title
                    const userTitle = getUserTitleDisplay(user.title || '', user.customTitle || '', user.isPremium || false, user.youtuberTitles || [], user.activeYoutuberTitle || null, youtuberTitles);

                    tableHTML += `
                        <tr class="${rowClass}">
                            <td class="rank ${rankClass}">${rankDisplay}</td>
                            <td>${user.username}${isCurrentUser ? ' (You)' : ''}</td>
                            <td class="title-cell">${userTitle}</td>
                            <td>${user.maxLevel}</td>
                            <td>${user.gamesPlayed}</td>
                        </tr>
                    `;
                });

                tableHTML += '</tbody></table>';
                content.innerHTML = tableHTML;
            } catch (error) {
                console.error('Failed to load leaderboard:', error);
                const content = document.getElementById('leaderboard-content');
                content.innerHTML = '<div class="no-data">❌ Failed to load leaderboard. Please try again later.</div>';
            }
        }

        function getUserTitleDisplay(title, customTitle, isPremium, userYoutuberTitles = [], activeYoutuberTitle = null, youtuberTitlesData = {}) {
            // Active YouTuber title has highest priority
            if (activeYoutuberTitle) {
                const titleData = youtuberTitlesData[activeYoutuberTitle];
                if (titleData) {
                    return `<span class="youtuber-title">🎬 ${titleData.name}</span>`;
                }
            }
            
            if (isPremium && customTitle) {
                return `<span class="custom-title">✨ ${customTitle}</span>`;
            }
            
            const titles = {
                'swordmaster': '<span class="title-swordmaster">🗡️ Sword Master</span>',
                'champion': '<span class="title-champion">🏆 Champion</span>',
                'legendary': '<span class="title-legendary">👑 Legendary</span>',
                'pyromaniac': '<span class="title-pyromaniac">🔥 Pyromaniac</span>',
                'lightning': '<span class="title-lightning">⚡ Lightning Fingers</span>',
                'starborn': '<span class="title-starborn">🌟 Starborn</span>',
                'realitybender': '<span class="title-realitybender">🌈 Reality Bender</span>',
                'deathstypist': '<span class="title-deathstypist">💀 Death\'s Typist</span>',
                'quantum': '<span class="title-quantum">🚀 Quantum Warrior</span>',
                'universedestroyer': '<span class="title-universedestroyer">🌌 Universe Destroyer</span>',
                'allseeing': '<span class="title-allseeing">👁️ All-Seeing Typer</span>',
                'wordweaver': '<span class="title-wordweaver">🔮 Mystic Wordweaver</span>',
                'godslayer': '<span class="title-godslayer">⚡ Godslayer Typist</span>'
            };
            
            return titles[title] || '<span class="no-title">-</span>';
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'signup.html';
        }

        // Check if user is logged in
        if (!localStorage.getItem('currentUser')) {
            window.location.href = 'signup.html';
        }

        loadLeaderboard();
    </script>
</body>
</html>
